# Office Dashboard for ESP32-P4 (Portrait 480x800)
# Based on DisplayEntry theme and layout
# ESPHome 2025.12.3

esphome:
  name: esp32-p4-office-dash
  friendly_name: "Office Dashboard"

# ========== SUBSTITUTIONS ==========
substitutions:
  # Weather entities (matching DisplayEntry setup)
  weather_entity: "weather.pirateweather"
  temperature_entity: "sensor.pirateweather_temperature"
  humidity_entity: "sensor.pirateweather_humidity"

  # Timezone
  timezone: "America/Chicago"

  # Icons (using Material Design Icons)
  lock_variant_icon: "\U000F0341"
  brightness_icon: "\U000F1A4D"
  home_icon: "\U000F06A1"
  weather_icon: "\U000F18F6"
  ceiling_lights_icon: "\U000F18DD"
  humidity_icon: "\U0000e938"
  temperature_icon: "\U0000e939"

# ========== ESP32-P4 CONFIGURATION ==========
esp32:
  board: esp32-p4
  variant: esp32p4
  flash_size: 16MB
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_SPIRAM: y
      CONFIG_SPIRAM_SIZE: "33554432"
      CONFIG_SPIRAM_MODE_HEX: y
      CONFIG_SPIRAM_SPEED_200M: y
      CONFIG_SPIRAM_XIP_FROM_PSRAM: y

# ========== ESP32-HOSTED (WiFi via C6) ==========
esp32_hosted:
  variant: ESP32C6
  reset_pin: GPIO54
  active_high: true
  clk_pin: GPIO18
  cmd_pin: GPIO19
  d0_pin: GPIO14
  d1_pin: GPIO15
  d2_pin: GPIO16
  d3_pin: GPIO17

# ========== NETWORK ==========
wifi:
  ssid: "futbolislife"
  password: "977Pokhara061"

api:
  encryption:
    key: "08pUFSMsU9yzYSR7uZGjM6FmMdw8d2GYpFM2FEMGnh8="

ota:
  - platform: esphome
    password: "esphome123"

logger:
  level: DEBUG

# ========== PSRAM & LDO ==========
psram:
  mode: hex
  speed: 200MHz

esp_ldo:
  - channel: 3
    voltage: 2.5V

# ========== TIME ==========
time:
  - platform: homeassistant
    id: homeassistant_time
    timezone: "${timezone}"

  - platform: sntp
    id: sntp_time
    timezone: "${timezone}"
    servers:
      - pool.ntp.org
      - time.google.com

# ========== SENSORS ==========
sensor:
  # WiFi Signal Strength
  - platform: wifi_signal
    name: "WiFi Signal Strength"
    id: wifi_signal_db
    update_interval: 30s

  # ESP32-P4 Internal Temperature
  - platform: internal_temperature
    name: "ESP32-P4 Temperature"
    id: esp32_temperature
    update_interval: 30s

  # System Uptime
  - platform: uptime
    name: "Uptime"
    id: uptime_sensor
    update_interval: 60s

  # Weather temperature (from weather entity attribute)
  - platform: homeassistant
    id: weather_temperature_sensor
    entity_id: "${weather_entity}"
    attribute: temperature
    on_value:
      then:
        - lvgl.label.update:
            id: weather_temperature_value
            text:
              format: "%.0f°"
              args: [id(weather_temperature_sensor).state]

  # Weather humidity (from weather entity attribute)
  - platform: homeassistant
    id: weather_humidity_sensor
    entity_id: "${weather_entity}"
    attribute: humidity
    on_value:
      then:
        - lvgl.label.update:
            id: weather_humidity_value
            text:
              format: "%.0f%%"
              args: [id(weather_humidity_sensor).state]

  # Home temperature sensor
  - platform: homeassistant
    id: home_temperature_sensor
    entity_id: "${temperature_entity}"
    on_value:
      then:
        - lvgl.label.update:
            id: circle_home_widget_temp_value
            text:
              format: "%.1f°"
              args: [id(home_temperature_sensor).state]

  # Home humidity sensor
  - platform: homeassistant
    id: home_humidity_sensor
    entity_id: "${humidity_entity}"
    on_value:
      then:
        - lvgl.label.update:
            id: circle_home_widget_hum_value
            text:
              format: "%.0f%%"
              args: [id(home_humidity_sensor).state]

# ========== TEXT SENSORS ==========
text_sensor:
  # WiFi IP Address
  - platform: wifi_info
    ip_address:
      name: "IP Address"
      id: wifi_ip_address

# ========== I2C BUS (for touchscreen) ==========
i2c:
  - id: i2c_bus
    sda: GPIO7
    scl: GPIO8
    scan: true
    frequency: 400kHz

# ========== TOUCHSCREEN ==========
touchscreen:
  - platform: gt911
    id: touch_screen
    i2c_id: i2c_bus
    address: 0x14
    interrupt_pin: GPIO21
    reset_pin: GPIO47
    update_interval: 20ms
    transform:
      swap_xy: false
      mirror_x: false
      mirror_y: false
    on_touch:
      then:
        - light.turn_on: display_backlight

# ========== BACKLIGHT ==========
output:
  - platform: ledc
    pin: GPIO23
    id: backlight_pwm
    frequency: 100Hz

light:
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    id: display_backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 250ms

# ========== DISPLAY ==========
display:
  - platform: mipi_dsi
    id: main_display
    model: JC4880P443
    reset_pin: GPIO5
    rotation: 0
    dimensions:
      width: 480
      height: 800
    lanes: 2
    pclk_frequency: 10MHz

# ========== FONTS ==========
font:
  # Nunito text fonts
  - file: "assets/fonts/Nunito-SemiBold.ttf"
    id: nunito_16
    size: 16
    bpp: 4
    glyphsets:
      - GF_Latin_Core

  - file: "assets/fonts/Nunito-SemiBold.ttf"
    id: nunito_18
    size: 18
    bpp: 4
    glyphsets:
      - GF_Latin_Core

  - file: "assets/fonts/Nunito-SemiBold.ttf"
    id: nunito_20
    size: 20
    bpp: 4
    glyphsets:
      - GF_Latin_Core

  - file: "assets/fonts/Nunito-SemiBold.ttf"
    id: nunito_24
    size: 24
    bpp: 4
    glyphsets:
      - GF_Latin_Core

  - file: "assets/fonts/Nunito-SemiBold.ttf"
    id: nunito_30
    size: 30
    bpp: 4
    glyphsets:
      - GF_Latin_Core

  - file: "assets/fonts/Nunito-SemiBold.ttf"
    id: nunito_36
    size: 36
    bpp: 4
    glyphsets:
      - GF_Latin_Core

  - file: "assets/fonts/Nunito-SemiBold.ttf"
    id: nunito_48
    size: 48
    bpp: 4
    glyphsets:
      - GF_Latin_Core

  - file: "assets/fonts/Nunito-SemiBold.ttf"
    id: nunito_64
    size: 64
    bpp: 4
    glyphsets:
      - GF_Latin_Core

  # Icon fonts
  - file: "assets/fonts/icons_v2.ttf"
    id: icons_28
    size: 28
    bpp: 4
    glyphs: [
      "\U0000e92e", # lock
      "\U0000e908", # lightbulb
      "\U0000e938", # humidity
      "\U0000e939", # temperature
    ]

  - file: "assets/fonts/materialdesignicons-webfont.ttf"
    id: mdi_icons_28
    size: 28
    bpp: 4
    glyphs: [
      "\U000F0341", # lock variant
      "\U000F1A4D", # brightness
      "\U000F06A1", # home
      "\U000F18F6", # weather
      "\U000F18DD", # ceiling lights
    ]

# ========== IMAGES ==========
image:
  # Weather condition images
  - file: "assets/images/weather-clear-night.png"
    id: weather_clear_night
    resize: 100x100
    type: RGB565

  - file: "assets/images/weather-cloudy.png"
    id: weather_cloudy
    resize: 100x100
    type: RGB565

  - file: "assets/images/weather-fog.png"
    id: weather_fog
    resize: 100x100
    type: RGB565

  - file: "assets/images/weather-lightning.png"
    id: weather_lightning
    resize: 100x100
    type: RGB565

  - file: "assets/images/weather-night-partly-cloudy.png"
    id: weather_night_partly_cloudy
    resize: 100x100
    type: RGB565

  - file: "assets/images/weather-partly-cloudy.png"
    id: weather_partly_cloudy
    resize: 100x100
    type: RGB565

  - file: "assets/images/weather-pouring.png"
    id: weather_pouring
    resize: 100x100
    type: RGB565

  - file: "assets/images/weather-rainy.png"
    id: weather_rainy
    resize: 100x100
    type: RGB565

  - file: "assets/images/weather-snowy.png"
    id: weather_snowy
    resize: 100x100
    type: RGB565

  - file: "assets/images/weather-sunny.png"
    id: weather_sunny
    resize: 100x100
    type: RGB565

# ========== COLORS ==========
# Exact color palette from DisplayEntry theme
color:
  - id: color_black
    hex: "0d0d0d"
  - id: color_white
    hex: "f2f0eb"
  - id: color_slate_blue_gray
    hex: "343645"
  - id: color_steel_blue
    hex: "606682"
  - id: color_misty_blue
    hex: "9BA2BC"
  - id: color_sky_blue
    hex: "3FA7F3"
  - id: color_blue
    hex: "4C9FFF"
  - id: color_green
    hex: "5CA848"
  - id: color_red
    hex: "ff0000"
  - id: color_yellow
    hex: "e7c12c"
  - id: color_orange
    hex: "f07c40"
  - id: color_gray
    hex: "666666"
  - id: color_dark_gray
    hex: "333333"
  - id: color_light_gray
    hex: "999999"

# ========== LVGL UI ==========
lvgl:
  displays: main_display
  touchscreens: touch_screen
  buffer_size: 25%
  color_depth: 16
  byte_order: little_endian

  pages:
    # ========== HOME PAGE ==========
    - id: home_page
      bg_color: color_black
      scrollable: false
      widgets:
        # TOP CARD: Time/Date/Info
        - obj:
            id: main_widget_background
            y: 10
            width: 460
            height: 200
            align: TOP_MID
            clickable: false
            scrollable: false
            radius: 20
            pad_all: 0
            bg_color: color_slate_blue_gray
            border_opa: TRANSP
            shadow_opa: TRANSP
            widgets:
              # Time Display
              - label:
                  id: time_label
                  x: 0
                  y: 15
                  align: TOP_MID
                  text_font: nunito_64
                  text_color: color_misty_blue
                  text: "12:00"

              - label:
                  id: time_period
                  x: 0
                  y: 85
                  align: TOP_MID
                  text_font: nunito_24
                  text_color: color_steel_blue
                  text: "PM"

              # Date Display
              - label:
                  id: date_label
                  y: 115
                  align: TOP_MID
                  text_font: nunito_18
                  text_color: color_misty_blue
                  text: "Friday, Jan 03"

              # Kathmandu Time
              - label:
                  id: kathmandu_time_label
                  y: 140
                  align: TOP_MID
                  text_font: nunito_16
                  text_color: color_steel_blue
                  text: "Kathmandu: 11:45 PM"

              # Divider Line
              - obj:
                  y: 162
                  width: 420
                  height: 2
                  align: TOP_MID
                  bg_color: color_misty_blue
                  border_opa: TRANSP
                  shadow_opa: TRANSP

              # WiFi & System info
              - label:
                  id: wifi_signal_label
                  x: 20
                  y: 172
                  text: "WiFi: -50 dBm"
                  text_color: color_green
                  text_font: nunito_16

              - label:
                  id: ip_label
                  x: -20
                  y: 172
                  align: TOP_RIGHT
                  text: "192.168.1.100"
                  text_color: color_blue
                  text_font: nunito_16

              - label:
                  id: chip_temp_label
                  x: 0
                  y: -10
                  align: BOTTOM_MID
                  text: "CPU: 45.0°C"
                  text_color: color_orange
                  text_font: nunito_16

        # MIDDLE CARD: Home Controls with Neomorphic Light Button
        - obj:
            id: middle_widget_background
            y: 220
            width: 460
            height: 100
            align: TOP_MID
            clickable: false
            scrollable: false
            radius: 20
            pad_all: 0
            bg_color: color_slate_blue_gray
            border_opa: TRANSP
            shadow_opa: TRANSP
            widgets:
              # Light control button (left side) - Neomorphic style
              - obj:
                  id: home_lights_btn_bg
                  x: 40
                  width: 90
                  height: 90
                  align: LEFT_MID
                  pad_all: 0
                  bg_opa: TRANSP
                  shadow_opa: TRANSP
                  border_opa: TRANSP
                  widgets:
                    - button:
                        id: home_lights_btn
                        width: 70
                        height: 70
                        align: CENTER
                        clickable: true
                        radius: 50
                        pad_all: 0
                        bg_opa: TRANSP
                        border_opa: TRANSP
                        shadow_width: 8
                        shadow_spread: 2
                        shadow_ofs_y: 0
                        shadow_color: color_black
                        shadow_opa: COVER
                        pressed:
                          bg_color: color_steel_blue
                          shadow_width: 4

                    # Highlight shadow
                    - obj:
                        width: 60
                        height: 60
                        align: CENTER
                        clickable: false
                        radius: 45
                        pad_all: 0
                        bg_opa: TRANSP
                        border_opa: TRANSP
                        shadow_width: 4
                        shadow_color: 0xFFFFFF
                        shadow_ofs_x: -4
                        shadow_ofs_y: -2
                        shadow_opa: 30%

                    # Center circle with icon
                    - obj:
                        width: 65
                        height: 65
                        pad_all: 0
                        align: CENTER
                        clickable: false
                        radius: 50
                        border_opa: TRANSP
                        bg_color: color_slate_blue_gray
                        widgets:
                          - label:
                              align: CENTER
                              text: "${ceiling_lights_icon}"
                              text_color: color_misty_blue
                              text_font: mdi_icons_28

              # Weather display on right
              - obj:
                  id: weather_widget
                  x: -40
                  width: 120
                  height: 80
                  align: RIGHT_MID
                  clickable: false
                  bg_opa: TRANSP
                  border_opa: TRANSP
                  shadow_opa: TRANSP
                  widgets:
                    - label:
                        id: weather_temperature_value
                        y: -5
                        align: CENTER
                        text: "22°"
                        text_color: color_misty_blue
                        text_font: nunito_20
                    - label:
                        id: weather_humidity_value
                        y: 20
                        align: CENTER
                        text: "65%"
                        text_color: color_steel_blue
                        text_font: nunito_16

        # CIRCLE Widget with Temp/Humidity Arcs (overlaps middle card)
        - obj:
            id: circle_widget_background
            y: 80
            width: 150
            height: 150
            align: CENTER
            clickable: false
            radius: 75
            pad_all: 0
            bg_color: color_black
            border_opa: TRANSP
            shadow_opa: TRANSP
            widgets:
              - obj:
                  width: 100
                  height: 100
                  pad_all: 0
                  align: CENTER
                  clickable: false
                  radius: 50
                  border_opa: TRANSP
                  bg_color: color_slate_blue_gray

              - obj:
                  id: circle_home_widget
                  width: 150
                  height: 150
                  align: CENTER
                  clickable: false
                  radius: 75
                  pad_all: 0
                  bg_opa: TRANSP
                  border_opa: TRANSP
                  shadow_opa: TRANSP
                  widgets:
                    # Temperature arc
                    - arc:
                        id: circle_home_widget_temp_arc
                        clickable: false
                        adjustable: false
                        align: CENTER
                        width: 130
                        height: 130
                        start_angle: 180
                        end_angle: 360
                        arc_width: 5
                        arc_color: color_orange
                        arc_rounded: false
                        value: 50

                    # Humidity arc
                    - arc:
                        id: circle_home_widget_hum_arc
                        clickable: false
                        adjustable: false
                        align: CENTER
                        width: 140
                        height: 140
                        start_angle: 0
                        end_angle: 180
                        arc_width: 5
                        arc_color: color_blue
                        arc_rounded: false
                        value: 50

                    # Temperature value
                    - label:
                        id: circle_home_widget_temp_value
                        y: -10
                        align: CENTER
                        text_font: nunito_24
                        text_color: color_misty_blue
                        text: "22.5°"

                    # Humidity value
                    - label:
                        id: circle_home_widget_hum_value
                        y: 15
                        align: CENTER
                        text_font: nunito_16
                        text_color: color_misty_blue
                        text: "45%"

        # BOTTOM CARD: Navigation Buttons
        - obj:
            id: menu_controls_background
            x: 0
            y: -20
            width: 460
            height: 60
            pad_all: 0
            align: BOTTOM_MID
            bg_color: color_slate_blue_gray
            shadow_opa: TRANSP
            border_opa: TRANSP
            radius: 20
            widgets:
              # Lock button
              - button:
                  id: display_lock_btn
                  clickable: true
                  x: 10
                  width: 50
                  height: 50
                  align: LEFT_MID
                  bg_opa: TRANSP
                  shadow_opa: TRANSP
                  widgets:
                    - label:
                        id: display_lock_indicator
                        align: CENTER
                        text_color: color_misty_blue
                        text_font: mdi_icons_28
                        text: "${lock_variant_icon}"

              # Brightness button
              - button:
                  id: backlight_brightness_btn
                  clickable: true
                  x: 60
                  width: 50
                  height: 50
                  align: LEFT_MID
                  bg_opa: TRANSP
                  shadow_opa: TRANSP
                  widgets:
                    - label:
                        align: CENTER
                        text_color: color_misty_blue
                        text_font: mdi_icons_28
                        text: "${brightness_icon}"
                  on_click:
                    - light.toggle: display_backlight

              # Home button
              - button:
                  id: home_widget_btn
                  clickable: true
                  x: 110
                  width: 50
                  height: 50
                  align: LEFT_MID
                  bg_opa: TRANSP
                  shadow_opa: TRANSP
                  widgets:
                    - label:
                        align: CENTER
                        text_color: color_misty_blue
                        text_font: mdi_icons_28
                        text: "${home_icon}"

              # Weather button
              - button:
                  id: weather_widget_btn
                  clickable: true
                  x: -110
                  width: 50
                  height: 50
                  align: RIGHT_MID
                  bg_opa: TRANSP
                  shadow_opa: TRANSP
                  widgets:
                    - label:
                        align: CENTER
                        text_color: color_misty_blue
                        text_font: mdi_icons_28
                        text: "${weather_icon}"

# ========== UPDATE INTERVALS ==========
interval:
  # Update Time and Date every 1 second
  - interval: 1s
    then:
      - lambda: |-
          auto time = id(homeassistant_time).now();
          if (time.is_valid()) {
            // Local time in 12-hour AM/PM format
            int hour_12 = time.hour % 12;
            if (hour_12 == 0) hour_12 = 12;
            char time_str[10];
            snprintf(time_str, sizeof(time_str), "%d:%02d", hour_12, time.minute);
            lv_label_set_text(id(time_label), time_str);

            // AM/PM
            lv_label_set_text(id(time_period), time.hour < 12 ? "AM" : "PM");

            // Date: "Friday, Jan 03"
            const char* days[] = {"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
            const char* months[] = {"", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
            char date_str[64];
            snprintf(date_str, sizeof(date_str), "%s, %s %02d",
                     days[time.day_of_week - 1],
                     months[time.month],
                     time.day_of_month);
            lv_label_set_text(id(date_label), date_str);

            // Kathmandu time (UTC+5:45, +11:15 from Chicago UTC-6)
            int kathmandu_hour = (time.hour + 11) % 24;
            int kathmandu_minute = (time.minute + 45) % 60;
            if (time.minute + 45 >= 60) kathmandu_hour = (kathmandu_hour + 1) % 24;

            int ktm_hour_12 = kathmandu_hour % 12;
            if (ktm_hour_12 == 0) ktm_hour_12 = 12;
            char ktm_str[64];
            snprintf(ktm_str, sizeof(ktm_str), "Kathmandu: %d:%02d %s",
                     ktm_hour_12, kathmandu_minute,
                     kathmandu_hour < 12 ? "AM" : "PM");
            lv_label_set_text(id(kathmandu_time_label), ktm_str);
          }

  # Update WiFi and temperature
  - interval: 5s
    then:
      - lambda: |-
          // WiFi signal
          if (!isnan(id(wifi_signal_db).state)) {
            char signal_str[30];
            snprintf(signal_str, sizeof(signal_str), "WiFi: %.0f dBm", id(wifi_signal_db).state);
            lv_label_set_text(id(wifi_signal_label), signal_str);
          }

          // IP address
          std::string ip = id(wifi_ip_address).state;
          std::string ip_text = "IP: " + ip;
          lv_label_set_text(id(ip_label), ip_text.c_str());

          // CPU temperature
          if (!isnan(id(esp32_temperature).state)) {
            char temp_str[30];
            snprintf(temp_str, sizeof(temp_str), "CPU: %.1f°C", id(esp32_temperature).state);
            lv_label_set_text(id(chip_temp_label), temp_str);
          }
